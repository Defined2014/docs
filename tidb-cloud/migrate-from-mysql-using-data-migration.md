---
title: Migrate MySQL-Compatible Databases to TiDB Cloud Using Data Migration
summary: Learn how to migrate data from MySQL-compatible databases hosted in Amazon Aurora MySQL, Amazon Relational Database Service (RDS), or a local MySQL instance to TiDB Cloud using Data Migration.
---

# データ移行を使用して MySQL 互換データベースをTiDB Cloudに移行する {#migrate-mysql-compatible-databases-to-tidb-cloud-using-data-migration}

このドキュメントでは、 TiDB Cloudコンソールのデータ移行機能を使用して、クラウドプロバイダー (Amazon Aurora MySQL または Amazon Relational Database Service (RDS)) またはオンプレミス上の MySQL 互換データベースからTiDB Cloudにデータを移行する方法について説明します。

この機能は、データベースとその進行中の変更をTiDB Cloudに (同じリージョン内またはリージョン間で) 移行するのに役立ちます。 DumplingやTiDB Lightningなどのツールを必要とするソリューションと比較して、この機能は使いやすいです。ソース データベースからデータを手動でダンプして、それをTiDB Cloudにインポートする必要はありません。代わりに、一度にソース データベースからTiDB Cloudにデータを直接移行できます。

## 制限事項 {#limitations}

-   データ移行機能は、**Dedicated Tier**クラスターでのみ使用できます。

-   データ移行機能は、2022 年 11 月 9 日以降に次のリージョンで作成されたプロジェクトのクラスターでのみ使用できます。**プロジェクトが**その日より前に作成された場合、またはクラスターが別のリージョンにある場合、この機能はクラスターでは使用できません。また、 **[データ移行]**タブは、 TiDB Cloudコンソールのクラスター概要ページに表示されません。

    -   AWS オレゴン州 (us-west-2)
    -   AWS 北バージニア (us-east-1)
    -   AWS ムンバイ (ap-south-1)
    -   AWS シンガポール (ap-southeast-1)
    -   AWS 東京 (ap-northeast-1)
    -   AWS フランクフルト (eu-central-1)

-   組織ごとに最大 200 個の移行ジョブを作成できます。さらに移行ジョブを作成するには、 [サポートチケットを提出する](/tidb-cloud/tidb-cloud-support.md)を実行する必要があります。

-   移行するデータベースをすべて選択した場合でも、システム データベースはフィルターで除外され、 TiDB Cloudには移行されません。つまり、 `mysql` 、 `information_schema` 、 `information_schema` 、および`sys`は、この機能を使用して移行されません。

-   完全なデータ移行中に、移行対象のテーブルが重複キーを持つターゲット データベースにすでに存在する場合、重複キーは置き換えられます。

-   増分データ移行中に、移行対象のテーブルが重複したキーを持つターゲット データベースにすでに存在する場合、エラーが報告され、移行は中断されます。この状況では、アップストリーム データが正確かどうかを確認する必要があります。 「はい」の場合、移行ジョブの「再開」ボタンをクリックすると、移行ジョブは競合する下流のレコードを上流のレコードに置き換えます。

-   TiDB Cloudでクラスターを削除すると、そのクラスター内のすべての移行ジョブが自動的に削除され、回復できなくなります。

-   増分レプリケーション (進行中の変更をクラスターに移行する) 中に、移行ジョブが突然のエラーから回復すると、セーフ モードが 60 秒間開くことがあります。セーフ モードでは、 `INSERT`ステートメントは`REPLACE`として、 `UPDATE`ステートメントは`DELETE`および`REPLACE`としてレプリケートされ、その後、これらのトランザクションはダウンストリーム クラスターにレプリケートされ、突然のエラー中のすべてのデータがダウンストリーム クラスターにスムーズに移行されたことを確認します。主キーや非 null の一意のインデックスがないアップストリーム テーブルの場合、データがダウンストリームに繰り返し挿入される可能性があるため、一部のデータがダウンストリーム クラスターで重複する可能性があります。

-   データ移行を使用する場合は、データセットのサイズを 1 TiB 未満に保つことをお勧めします。データセットのサイズが 1 TiB より大きい場合、仕様が制限されているため、完全なデータの移行に時間がかかります。

-   次のシナリオでは、移行ジョブに 24 時間以上かかる場合は、データ移行が増分レプリケーション用に連続したバイナリ ログを取得できるように、ソース データベースのバイナリ ログをパージしないでください。

    -   完全なデータ移行中。
    -   完全なデータ移行が完了し、増分データ移行が初めて開始されるとき、レイテンシーは0 ミリ秒ではありません。

## 前提条件 {#prerequisites}

移行を実行する前に、データ ソースを確認し、上流および下流のデータベースに対する権限を準備し、ネットワーク接続を設定する必要があります。

### データ ソースとバージョンがサポートされていることを確認してください {#make-sure-your-data-source-and-version-are-supported}

データ移行は、次のデータ ソースとバージョンをサポートします。

-   MySQL 5.6、5.7、および 8.0 のローカル インスタンスまたはパブリック クラウド プロバイダー上。 MySQL 8.0 はTiDB Cloud上でまだ実験的にあるため、非互換性の問題が発生する可能性があることに注意してください。
-   Amazon Aurora (MySQL 5.6 および 5.7)
-   Amazon RDS (MySQL 5.7)

### 上流データベースに必要な権限を付与します。 {#grant-required-privileges-to-the-upstream-database}

アップストリーム データベースに使用するユーザー名には、次のすべての権限が必要です。

| 特権                   | 範囲    |
| :------------------- | :---- |
| `SELECT`             | テーブル  |
| `LOCK`               | テーブル  |
| `REPLICATION SLAVE`  | グローバル |
| `REPLICATION CLIENT` | グローバル |

たとえば、次の`GRANT`ステートメントを使用して、対応する権限を付与できます。

```sql
GRANT SELECT,LOCK TABLES,REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO 'your_user'@'your_IP_address_of_host'
```

### ダウンストリームTiDB Cloudクラスターに必要な権限を付与します。 {#grant-required-privileges-to-the-downstream-tidb-cloud-cluster}

ダウンストリームTiDB Cloudクラスターに使用するユーザー名には、次の権限が必要です。

| 特権         | 範囲          |
| :--------- | :---------- |
| `CREATE`   | データベース、テーブル |
| `SELECT`   | テーブル        |
| `INSERT`   | テーブル        |
| `UPDATE`   | テーブル        |
| `DELETE`   | テーブル        |
| `ALTER`    | テーブル        |
| `DROP`     | データベース、テーブル |
| `INDEX`    | テーブル        |
| `TRUNCATE` | テーブル        |

たとえば、次の`GRANT`ステートメントを実行して、対応する権限を付与できます。

```sql
GRANT CREATE,SELECT,INSERT,UPDATE,DELETE,ALTER,TRUNCATE,DROP,INDEX ON *.* TO 'your_user'@'your_IP_address_of_host'
```

移行ジョブを迅速にテストするには、 TiDB Cloudクラスターの`root`アカウントを使用できます。

### ネットワーク接続をセットアップする {#set-up-network-connection}

移行ジョブを作成する前に、接続方法に従ってネットワーク接続を設定します。 [TiDBクラスタに接続する](/tidb-cloud/connect-to-tidb-cluster.md)を参照してください。

-   ネットワーク接続にパブリック IP (標準接続) を使用する場合は、上流のデータベースがパブリック ネットワーク経由で接続できることを確認してください。

-   VPC ピアリングを使用する場合は、 [VPC ピアリングリクエストの追加](/tidb-cloud/set-up-vpc-peering-connections.md#step-1-add-vpc-peering-requests)に従って設定します。

-   AWS PrivateLink を使用する場合は、 [プライベートエンドポイント接続のセットアップ](/tidb-cloud/set-up-private-endpoint-connections.md)に従って設定します。

### バイナリログを有効にする {#enable-binlogs}

増分データ移行を実行するには、アップストリーム データベースのバイナリ ログが有効になっていて、バイナリ ログが 24 時間以上保存されていることを確認してください。

## ステップ 1:<strong>データ移行</strong>ページに移動する {#step-1-go-to-the-strong-data-migration-strong-page}

1.  [**クラスター**](https://tidbcloud.com/console/clusters)ページに移動します。

    > **ヒント：**
    >
    > 複数のプロジェクトがある場合は、 **「クラスター」**ページの左側のナビゲーション・ペインでターゲット・プロジェクトに切り替えることができます。

2.  ターゲット クラスターの名前をクリックして概要ページに移動し、左側のナビゲーション ペインで**[データ移行]**をクリックします。

3.  **[データ移行]**ページで、右上隅にある**[移行ジョブの作成]**をクリックします。 **「移行ジョブの作成」**ページが表示されます。

## ステップ 2: ソース接続とターゲット接続を構成する {#step-2-configure-the-source-and-target-connection}

**[移行ジョブの作成]**ページで、ソース接続とターゲット接続を構成します。

1.  ジョブ名を入力します。ジョブ名は文字で始まり、60 文字未満である必要があります。文字 (A ～ Z、az)、数字 (0 ～ 9)、アンダースコア (_)、およびハイフン (-) を使用できます。

2.  ソース接続プロファイルを入力します。

    -   **データ ソース**: データ ソースの種類。
    -   **リージョン**: データ ソースのリージョン。クラウド データベースにのみ必要です。
    -   **接続方法**: データ ソースの接続方法。現在、接続方法に応じてパブリック IP、VPC ピアリング、またはプライベート リンクを選択できます。
    -   **ホスト名または IP アドレス**(パブリック IP および VPC ピアリングの場合): データ ソースのホスト名または IP アドレス。
    -   **サービス名**(Private Link の場合): エンドポイント サービス名。
    -   **ポート**: データ ソースのポート。
    -   **ユーザー名**: データ ソースのユーザー名。
    -   **パスワード**: ユーザー名のパスワード。
    -   **SSL/TLS** : SSL/TLS を有効にする場合は、次のいずれかを含むデータ ソースの証明書をアップロードする必要があります。
        -   CA証明書のみ
        -   クライアント証明書とクライアントキー
        -   CA証明書、クライアント証明書、クライアントキー

3.  ターゲット接続プロファイルを入力します。

    -   **ユーザー名**: TiDB Cloudのターゲットクラスターのユーザー名を入力します。
    -   **パスワード**: TiDB Cloudユーザー名のパスワードを入力します。

4.  **「接続を検証して次へ」**をクリックして、入力した情報を検証します。

5.  表示されるメッセージに従ってアクションを実行します。

    -   パブリック IP または VPC ピアリングを使用する場合は、ソース データベースとファイアウォール (存在する場合) の IP アクセス リストにデータ移行サービスの IP アドレスを追加する必要があります。
    -   Private Link を使用する場合は、エンドポイント要求を受け入れるように求められます。 [AWS VPC コンソール](https://us-west-2.console.aws.amazon.com/vpc/home)に移動し、 **「エンドポイント サービス」**をクリックしてエンドポイント要求を受け入れます。

## ステップ 3: 移行するオブジェクトを選択する {#step-3-choose-the-objects-to-be-migrated}

1.  チェックボックスを選択して、完全なデータ移行、増分データ移行、またはその両方を選択します。

    > **ヒント：**
    >
    > -   TiDB Cloudにデータを一度に移行するには、 **[完全なデータ移行]**と**[増分データ移行]**の両方を選択します。これにより、ソース データベースとターゲット データベース間のデータの一貫性が確保されます。
    > -   ソース データベースの既存のデータのみをTiDB Cloudに移行するには、 **[全データ移行]**チェックボックスのみを選択します。

2.  **「移行するオブジェクトの選択」**ページで、移行するオブジェクトを選択します。 **「すべて」**をクリックしてすべてのオブジェクトを選択するか、 **「カスタマイズ」**をクリックしてオブジェクト名の横にあるチェックボックスをクリックしてオブジェクトを選択します。

    -   **「すべて」**をクリックすると、移行ジョブはソース・データベース・インスタンス全体から既存のデータをTiDB Cloudに移行し、完全な移行後に進行中の変更を複製します。これは、前の手順で**[完全なデータ移行]**チェックボックスと**[増分データ移行]**チェックボックスを選択した場合にのみ発生することに注意してください。

        <img src="https://download.pingcap.com/images/docs/tidb-cloud/migration-job-select-all.png" width="60%" />

    -   **「カスタマイズ」**をクリックしてデータベースを選択すると、移行ジョブによって既存のデータが移行され、選択したデータベースの進行中の変更がTiDB Cloudに複製されます。これは、前の手順で**[完全なデータ移行]**チェックボックスと**[増分データ移行]**チェックボックスを選択した場合にのみ発生することに注意してください。

        <img src="https://download.pingcap.com/images/docs/tidb-cloud/migration-job-select-db.png" width="60%" />

    -   **[カスタマイズ]**をクリックし、データセット名の下でいくつかのテーブルを選択すると、移行ジョブのみが既存のデータを移行し、選択したテーブルの進行中の変更をレプリケートします。同じデータベース内に後で作成されたテーブルは移行されません。

        <img src="https://download.pingcap.com/images/docs/tidb-cloud/migration-job-select-tables.png" width="60%" />

    <!--
     - If you click **Customize** and select some databases, and then select some tables in the **Selected Objects** area to move them back to the **Source Database** area, (for example the `username` table in the following screenshots), then the tables will be treated as in a blocklist. The migration job will migrate the existing data but filter out the excluded tables (such as the `username` table in the screenshots), and will replicate ongoing changes of the selected databases to TiDB Cloud except the filtered-out tables.
         ![Select Databases and Deselect Some Tables](/media/tidb-cloud/migration-job-select-db-blacklist1.png)
         ![Select Databases and Deselect Some Tables](/media/tidb-cloud/migration-job-select-db-blacklist2.png)
     -->

3.  **「次へ」**をクリックします。

## ステップ 4: 事前チェック {#step-4-precheck}

**[事前チェック]**ページでは、事前チェックの結果を表示できます。事前チェックが失敗した場合は、「**失敗」**または**「警告」の**詳細に従って操作し、 **「再度チェック」を**クリックして再チェックする必要があります。

一部のチェック項目に警告のみがある場合は、リスクを評価し、警告を無視するかどうかを検討できます。すべての警告が無視された場合、移行ジョブは自動的に次のステップに進みます。

事前チェック項目の詳細については、 [移行タスクの事前チェック](https://docs.pingcap.com/tidb/stable/dm-precheck)を参照してください。

すべてのチェック項目に**「合格」**と表示されている場合は、 **「次へ」**をクリックします。

## ステップ 5: 仕様を選択して移行を開始する {#step-5-choose-a-spec-and-start-migration}

**「仕様を選択して移行を開始」**ページで、パフォーマンス要件に応じて適切な移行仕様を選択します。仕様の詳細については、 [データ移行の仕様](/tidb-cloud/tidb-cloud-billing-dm.md#specifications-for-data-migration)を参照してください。

仕様を選択した後、 **「ジョブを作成して開始」**をクリックして移行を開始します。

## ステップ 6: 移行の進行状況をビュー {#step-6-view-the-migration-progress}

移行ジョブの作成後、 **[移行ジョブの詳細]**ページで移行の進行状況を確認できます。移行の進行状況が**「ステージとステータス」**領域に表示されます。

実行中の移行ジョブを一時停止または削除できます。

移行ジョブが失敗した場合は、問題を解決した後に再開できます。

移行ジョブはどのステータスでも削除できます。

## トラブルシューティング {#troubleshooting}

移行中に問題が発生した場合は、次の解決策を参照してください。

-   エラー メッセージ: 「移行に必要なバイナリ ログは、ソース データベースに存在しません。移行が成功するために、バイナリ ログ ファイルが十分な期間保持されていることを確認してください。」

    このエラーは、移行するバイナリログがクリーンアップされており、新しいタスクを作成することによってのみ復元できることを意味します。

    増分移行に必要なバイナリログが存在することを確認してください。バイナリログの期間を延長するには、 `expire_logs_days`を設定することをお勧めします。移行ジョブで必要な場合は、バイナリログのクリーンアップに`purge binary log`を使用しないでください。

-   エラー メッセージ:「指定されたパラメーターを使用してソース データベースに接続できませんでした。ソース データベースが起動しており、指定されたパラメーターを使用して接続できることを確認してください。」

    このエラーは、ソース データベースへの接続が失敗したことを意味します。ソース データベースが起動されており、指定されたパラメータを使用して接続できるかどうかを確認します。ソース データベースが使用可能であることを確認した後、 **[再起動]**をクリックしてタスクの回復を試みることができます。

-   移行タスクが中断され、「ドライバー: 接続が正しくありません」または「接続が無効です」というエラーが発生します。

    このエラーは、ダウンストリーム TiDB クラスターへの接続が失敗したことを意味します。ダウンストリーム TiDB クラスターが`normal`状態にあり、ジョブで指定されたユーザー名とパスワードで接続できるかどうかを確認します。ダウンストリーム TiDB クラスターが使用可能であることを確認したら、 **[再起動]**をクリックしてタスクの再開を試みることができます。

-   エラー メッセージ: 「指定されたユーザーとパスワードを使用して TiDB クラスターに接続できませんでした。TiDBクラスタが起動しており、指定されたユーザーとパスワードを使用して接続できることを確認してください。」

    TiDB クラスターへの接続に失敗しました。 TiDB クラスターが`normal`状態にあり、ジョブで指定されたユーザー名とパスワードで接続できるかどうかを確認することをお勧めします。 TiDB クラスターが使用可能であることを確認したら、 **「再起動」**をクリックしてタスクの再開を試みることができます。

-   エラー メッセージ:「TiDB クラスターstorageが十分ではありません。TiKV のノードstorageを増やしてください。」

    TiDB クラスターのstorageが不足しています。 [TiKV ノードのstorageを増やす](/tidb-cloud/scale-tidb-cluster.md#increase-node-storage)し、 **[再起動]**をクリックしてタスクを再開することをお勧めします。

-   エラー メッセージ:「ソース データベースに接続できませんでした。データベースが利用可能か、または最大接続数に達しているかを確認してください。」

    ソースデータベースへの接続に失敗しました。ソースデータベースが起動しているか、データベース接続数が上限に達していないか、ジョブで指定したパラメータを使用して接続できるかを確認することをお勧めします。ソース データベースが使用可能であることを確認したら、 **[再起動]**をクリックしてジョブを再開できます。
