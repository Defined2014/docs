---
title: Database Audit Logging
summary: Learn about how to audit a cluster in TiDB Cloud.
---

# データベース監査ログ {#database-audit-logging}

TiDB Cloudは、ユーザー アクセスの詳細 (実行された SQL ステートメントなど) の履歴をログに記録するためのデータベース監査ログ機能を提供します。

組織のユーザー アクセス ポリシーおよびその他の情報セキュリティ対策の有効性を評価するには、データベース監査ログを定期的に分析することがセキュリティのベスト プラクティスです。

監査ログ機能はデフォルトで無効になっています。クラスターを監査するには、最初に監査ログを有効にしてから、監査フィルター ルールを指定する必要があります。

> **ノート：**
>
> 監査ログはクラスター リソースを消費するため、クラスターを監査するかどうかは慎重に検討してください。

## 前提条件 {#prerequisites}

-   TiDB Cloud Dedicated Tierクラスターを使用しています。監査ログは、 TiDB Cloud Tier クラスターでは使用できません。
-   あなたはTiDB Cloudの組織の監査管理者です。そうしないと、 TiDB Cloudコンソールに監査関連のオプションが表示されません。詳細については、 [メンバーの役割を構成する](/tidb-cloud/manage-user-access.md#configure-member-roles)を参照してください。

## AWS または GCP の監査ログを有効にする {#enable-audit-logging-for-aws-or-gcp}

TiDB Cloudが監査ログをクラウド バケットに書き込めるようにするには、最初に監査ログを有効にする必要があります。

### AWS の監査ログを有効にする {#enable-audit-logging-for-aws}

AWS の監査ログを有効にするには、次の手順を実行します。

#### ステップ 1.Amazon S3 バケットを作成する {#step-1-create-an-amazon-s3-bucket}

TiDB Cloudが監査ログを書き込む宛先として、企業所有の AWS アカウントで Amazon S3 バケットを指定します。

詳細については、AWS ユーザーガイドの[バケットの作成](https://docs.aws.amazon.com/AmazonS3/latest/userguide/create-bucket-overview.html)を参照してください。

#### ステップ 2.Amazon S3 アクセスを構成する {#step-2-configure-amazon-s3-access}

> **ノート：**
>
> プロジェクト内の 1 つのクラスターに対して Amazon S3 アクセス設定が実行されると、同じプロジェクト内のすべてのクラスターからの監査ログの宛先として同じバケットを使用できます。

1.  監査ログを有効にする TiDB クラスターのTiDB Cloudアカウント ID と外部 ID を取得します。

    1.  TiDB Cloudコンソールで、AWS にデプロイされたプロジェクトとクラスターを選択します。
    2.  [**設定]** &gt; [<strong>監査設定]</strong>を選択します。 [<strong>監査ログ</strong>] ダイアログが表示されます。
    3.  [**監査ログ**] ダイアログで、[ <strong>AWS IAMポリシー設定を表示</strong>] をクリックします。対応するTiDB Cloudアカウント ID と TiDB クラスターのTiDB Cloud外部 ID が表示されます。
    4.  後で使用するために、 TiDB Cloudアカウント ID と外部 ID を記録します。

2.  AWS マネジメント コンソールで、[ **IAM]** &gt; [<strong>アクセス管理</strong>] &gt; [<strong>ポリシー</strong>] に移動し、 `s3:PutObject`書き込み専用権限を持つストレージ バケット ポリシーがあるかどうかを確認します。

    -   はいの場合は、後で使用するために、一致したストレージ バケット ポリシーを記録します。
    -   そうでない場合は、[ **IAM]** &gt; [<strong>アクセス管理</strong>] &gt; [<strong>ポリシー]</strong> &gt; [ポリシーの<strong>作成]</strong>に移動し、次のポリシー テンプレートに従ってバケット ポリシーを定義します。

        ```json
        {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Action": "s3:PutObject",
                    "Resource": "<Your S3 bucket ARN>/*"
                }
            ]
        }
        ```

        テンプレートの`<Your S3 bucket ARN>`は、監査ログ ファイルが書き込まれる S3 バケットの Amazon リソース ネーム (ARN) です。 S3 バケットの [**プロパティ**] タブに移動し、[<strong>バケットの概要</strong>] エリアで ARN 値を取得できます。 `"Resource"`フィールドでは、ARN の後に`/*`を追加する必要があります。たとえば、ARN が`arn:aws:s3:::tidb-cloud-test`の場合、 `"Resource"`フィールドの値を`"arn:aws:s3:::tidb-cloud-test/*"`に設定する必要があります。

3.  **IAM** &gt; <strong>Access Management</strong> &gt; <strong>Roles</strong>に移動し、以前に記録したTiDB Cloudアカウント ID と外部 ID に対応する信頼エンティティを持つロールが既に存在するかどうかを確認します。

    -   はいの場合は、後で使用するために一致した役割を記録します。
    -   そうでない場合は、[**ロールの作成**] をクリックし、信頼エンティティ タイプとして [<strong>別の AWS アカウント</strong>] を選択し、 TiDB Cloudアカウント ID の値を [<strong>アカウント ID]</strong>フィールドに入力します。次に、[<strong>外部 ID</strong>が必要] オプションを選択し、 TiDB Cloudの外部 ID 値を [<strong>外部 ID</strong> ] フィールドに入力します。

4.  [ **IAM** ] &gt; [ <strong>Access Management</strong> ] &gt; [ <strong>Roles</strong> ] で、前の手順のロール名をクリックして<strong>[概要</strong>] ページに移動し、次の手順を実行します。

    1.  [**アクセス許可**] タブで、 `s3:PutObject`書き込み専用アクセス許可を持つ記録されたポリシーがロールに関連付けられているかどうかを確認します。そうでない場合は、[ポリシーのアタッチ] を選択し、必要な<strong>ポリシー</strong>を検索して、[<strong>ポリシーのアタッチ</strong>] をクリックします。
    2.  **[概要**] ページに戻り、 <strong>Role ARN</strong>値をクリップボードにコピーします。

#### ステップ 3.監査ログを有効にする {#step-3-enable-audit-logging}

TiDB Cloudコンソールで、 TiDB Cloudアカウント ID と外部 ID の値を取得した [**監査ログ**] ダイアログ ボックスに戻り、次の手順を実行します。

1.  [**バケット URI]**フィールドに、監査ログ ファイルが書き込まれる S3 バケットの URI を入力します。

2.  [**バケットリージョン]**ドロップダウン リストで、バケットが配置されている AWS リージョンを選択します。

3.  **Role ARN**フィールドに、 [ステップ 2.Amazon S3 アクセスを構成する](#step-2-configure-amazon-s3-access)でコピーした Role ARN 値を入力します。

4.  [ **Test Connectivity** ] をクリックして、 TiDB Cloudがバケットにアクセスして書き込みできるかどうかを確認します。

    成功すると**Pass**が表示されます。それ以外の場合は、アクセス構成を確認してください。

5.  右上隅で、監査設定を [**オン**] に切り替えます。

    TiDB Cloudは、指定されたクラスターの監査ログを Amazon S3 バケットに書き込む準備ができています。

> **ノート：**
>
> -   監査ログを有効にした後、バケット URI、場所、または ARN に新しい変更を加えた場合は、[**再起動**] をクリックして変更を読み込み、[<strong>接続のテスト</strong>] チェックを再実行して変更を有効にする必要があります。
> -   TiDB Cloudから Amazon S3 アクセスを削除するには、追加した信頼ポリシーを削除するだけです。

### GCP の監査ログを有効にする {#enable-audit-logging-for-gcp}

GCP の監査ログを有効にするには、次の手順を実行します。

#### ステップ 1.GCS バケットを作成する {#step-1-create-a-gcs-bucket}

企業所有の GCP アカウントの Google Cloud Storage (GCS) バケットを、 TiDB Cloudが監査ログを書き込む宛先として指定します。

詳細については、Google Cloud Storage ドキュメントの[ストレージ バケットの作成](https://cloud.google.com/storage/docs/creating-buckets)を参照してください。

#### ステップ 2.GCS アクセスを構成する {#step-2-configure-gcs-access}

> **ノート：**
>
> プロジェクト内の 1 つのクラスタに対して GCS アクセス構成が実行されると、同じプロジェクト内のすべてのクラスタからの監査ログの宛先として同じバケットを使用できます。

1.  監査ログを有効にする TiDB クラスタの Google Cloud サービス アカウント ID を取得します。

    1.  TiDB Cloudコンソールで、Google Cloud Platform にデプロイされたプロジェクトとクラスターを選択します。
    2.  [**設定]** &gt; [<strong>監査設定]</strong>を選択します。 [<strong>監査ログ</strong>] ダイアログ ボックスが表示されます。
    3.  [ **Google Cloud サービス アカウント ID を表示]**をクリックし、後で使用できるようにサービス アカウント ID をコピーします。

2.  Google Cloud Platform (GCP) 管理コンソールで、[ **IAM &amp; Admin** ] &gt; [ <strong>Roles</strong> ] に移動し、ストレージ コンテナーの次の書き込み専用権限を持つロールが存在するかどうかを確認します。

    -   storage.objects.create
    -   storage.objects.delete

    はいの場合は、後で使用するために、TiDB クラスターの一致した役割を記録します。そうでない場合は、[ **IAM &amp; Admin** ] &gt; [ <strong>Roles</strong> ] &gt; [ <strong>CREATE ROLE</strong> ] に移動して、TiDB クラスターのロールを定義します。

3.  **Cloud Storage** &gt; <strong>Browser</strong>に移動し、 TiDB Cloudがアクセスする GCS バケットを選択して、 <strong>SHOW INFO PANEL</strong>をクリックします。

    パネルが表示されます。

4.  パネルで、[**プリンシパル**を追加] をクリックします。

    プリンシパルを追加するためのダイアログ ボックスが表示されます。

5.  ダイアログ ボックスで、次の手順を実行します。

    1.  [**新しいプリンシパル**] フィールドに、TiDB クラスターの Google Cloud サービス アカウント ID を貼り付けます。
    2.  [**役割**] ドロップダウン リストで、ターゲット TiDB クラスターの役割を選択します。
    3.  [**保存]**をクリックします。

#### ステップ 3.監査ログを有効にする {#step-3-enable-audit-logging}

TiDB Cloudコンソールで、 TiDB Cloudアカウント ID を取得した [**監査ログ**] ダイアログ ボックスに戻り、次の手順を実行します。

1.  [**バケット URI]**フィールドに、完全な GCS バケット名を入力します。

2.  [ **Bucket リージョン ]**フィールドで、バケットが配置されている GCS リージョンを選択します。

3.  [ **Test Connectivity** ] をクリックして、 TiDB Cloudがバケットにアクセスして書き込みできるかどうかを確認します。

    成功すると**Pass**が表示されます。それ以外の場合は、アクセス構成を確認してください。

4.  右上隅で、監査設定を [**オン**] に切り替えます。

    TiDB Cloudは、指定されたクラスターの監査ログを Amazon S3 バケットに書き込む準備ができています。

> **ノート：**
>
> -   監査ログを有効にした後、バケット URI または場所に新しい変更を加えた場合は、[**再起動**] をクリックして変更を読み込み、[<strong>接続のテスト</strong>] チェックを再実行して変更を有効にする必要があります。
> -   TiDB Cloudから GCS アクセスを削除するには、追加したプリンシパルを削除するだけです。

## 監査フィルター規則を指定する {#specify-auditing-filter-rules}

監査ログを有効にした後、監査フィルター ルールを指定して、キャプチャして監査ログに書き込むユーザー アクセス イベントと無視するイベントを制御する必要があります。フィルター規則が指定されていない場合、 TiDB Cloudは何もログに記録しません。

クラスタの監査フィルタ ルールを指定するには、次の手順を実行します。

1.  **監査ログを有効にする [監査ログ**] ダイアログ ボックスで、下にスクロールして [<strong>フィルター ルール</strong>] セクションを見つけます。
2.  ユーザー式、データベース式、テーブル式、およびアクセス タイプを指定する各ルールで、1 行に 1 つのルールで 1 つ以上のフィルター ルールを追加します。

> **ノート：**
>
> -   フィルタ ルールは正規表現であり、大文字と小文字が区別されます。ワイルドカード ルール`.*`を使用すると、クラスター内のすべてのユーザー、データベース、またはテーブル イベントがログに記録されます。
> -   監査ログはクラスター リソースを消費するため、フィルター規則を指定するときは慎重に行ってください。消費を最小限に抑えるために、可能な場合は、フィルタ ルールを指定して、監査ログの範囲を特定のデータベース オブジェクト、ユーザー、およびアクションに制限することをお勧めします。

## 監査ログをビューする {#view-audit-logs}

TiDB Cloud監査ログは、クラスター ID、ポッド ID、およびログ作成日が完全修飾ファイル名に組み込まれた読み取り可能なテキスト ファイルです。

たとえば、 `13796619446086334065/tidb-0/tidb-audit-2022-04-21T18-16-29.529.log`です。この例では、 `13796619446086334065`はクラスター ID を示し、 `tidb-0`は Pod ID を示します。

## 監査ログを無効にする {#disable-audit-logging}

クラスターを監査する必要がなくなった場合は、クラスターのページに移動し、[**設定]** &gt; [<strong>監査設定]</strong>をクリックしてから、右上隅の監査設定を<strong>[オフ</strong>] に切り替えます。

> **ノート：**
>
> ログ ファイルのサイズが 10 MiB に達するたびに、ログ ファイルはクラウド ストレージ バケットにプッシュされます。したがって、監査ログが無効になった後、サイズが 10 MiB より小さいログ ファイルはクラウド ストレージ バケットに自動的にプッシュされません。この状況でログ ファイルを取得するには、 [PingCAP のサポート](/tidb-cloud/tidb-cloud-support.md)にお問い合わせください。

## 監査ログ フィールド {#audit-log-fields}

監査ログのデータベース イベント レコードごとに、TiDB は次のフィールドを提供します。

> **ノート：**
>
> 次の表で、フィールドの最大長が空であるということは、このフィールドのデータ型が明確に定義された一定の長さ (たとえば、INTEGER の場合は 4 バイト) であることを意味します。

| 列番号 | フィールド名         | TiDB データ型 | 最大長     | 説明                                 |
| --- | -------------- | --------- | ------- | ---------------------------------- |
| 1   | なし             | なし        | なし      | 内部使用のために予約済み                       |
| 2   | なし             | なし        | なし      | 内部使用のために予約済み                       |
| 3   | なし             | なし        | なし      | 内部使用のために予約済み                       |
| 4   | ID             | 整数        |         | 一意のイベント ID                         |
| 5   | タイムスタンプ        | タイムスタンプ   |         | 開催時間                               |
| 6   | EVENT_CLASS    | VARCHAR   | 15      | イベントタイプ                            |
| 7   | EVENT_SUBCLASS | VARCHAR   | 15      | イベントのサブタイプ                         |
| 8   | STATUS_CODE    | 整数        |         | ステートメントの応答ステータス                    |
| 9   | COST_TIME      | 整数        |         | ステートメントに費やされた時間                    |
| 10  | ホスト            | VARCHAR   | 16      | サーバー IP                            |
| 11  | CLIENT_IP      | VARCHAR   | 16      | クライアント IP                          |
| 12  | ユーザー           | VARCHAR   | 17      | ログインユーザー名                          |
| 13  | データベース         | VARCHAR   | 64      | イベント関連データベース                       |
| 14  | テーブル           | VARCHAR   | 64      | イベント関連テーブル名                        |
| 15  | SQL_TEXT       | VARCHAR   | 64キロバイト | マスクされた SQL ステートメント                 |
| 16  | 行              | 整数        |         | 影響を受ける行の数 ( `0`は影響を受ける行がないことを示します) |

TiDB によって設定された EVENT_CLASS フィールドの値に応じて、監査ログのデータベース イベント レコードには、次のような追加のフィールドも含まれます。

-   EVENT_CLASS 値が`CONNECTION`の場合、データベース イベント レコードには次のフィールドも含まれます。

    | 列番号 | フィールド名            | TiDB データ型 | 最大長 | 説明                                                   |
    | --- | ----------------- | --------- | --- | ---------------------------------------------------- |
    | 17  | CLIENT_PORT       | 整数        |     | クライアントのポート番号                                         |
    | 18  | CONNECTION_ID     | 整数        |     | 接続 ID                                                |
    | 19  | 接続タイプ             | VARCHAR   | 12  | `socket`または`unix-socket`経由の接続                        |
    | 20  | サーバー_ID           | 整数        |     | TiDBサーバーID                                           |
    | 21  | サーバポート            | 整数        |     | TiDBサーバーが MySQL プロトコルを介して通信するクライアントをリッスンするために使用するポート |
    | 22  | サーバー_OS_ログイン_ユーザー | VARCHAR   | 17  | TiDB プロセス起動システムのユーザー名                                |
    | 23  | OS_VERSION        | VARCHAR   | なし  | TiDBサーバーが配置されているオペレーティング システムのバージョン                  |
    | 24  | SSL_バージョン         | VARCHAR   | 6   | TiDB の現在の SSL バージョン                                  |
    | 25  | PID               | 整数        |     | TiDB プロセスの PID                                       |

-   EVENT_CLASS 値が`TABLE_ACCESS`または`GENERAL`の場合、データベース イベント レコードには次のフィールドも含まれます。

    | 列番号 | フィールド名        | TiDB データ型 | 最大長 | 説明                   |
    | --- | ------------- | --------- | --- | -------------------- |
    | 17  | CONNECTION_ID | 整数        |     | 接続 ID                |
    | 18  | 指図            | VARCHAR   | 14  | MySQL プロトコルのコマンド タイプ |
    | 19  | SQL_STATEMENT | VARCHAR   | 17  | SQL ステートメントのタイプ      |
    | 20  | PID           | 整数        |     | TiDB プロセスの PID       |
