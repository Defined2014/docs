---
title: TiFlash Data Validation
summary: Learn the data validation mechanism and tools for TiFlash.
---

# TiFlashデータ検証 {#tiflash-data-validation}

このドキュメントでは、 TiFlashのデータ検証メカニズムとツールを紹介します。

通常、データの破損は深刻なハードウェア障害によって引き起こされます。このような場合、手動でデータを回復しようとしても、データの信頼性が低下します。

データの整合性を確保するために、デフォルトでは、 TiFlash は`City128`アルゴリズムを使用して、データ ファイルに対して基本的なデータ検証を実行します。データの検証に失敗した場合、 TiFlash はすぐにエラーを報告して終了し、データの不一致による二次災害を回避します。この時点で、 TiFlashノードを復元する前に、手動で介入してデータを再度複製する必要があります。

v5.4.0 から、 TiFlash はより高度なデータ検証機能を導入しています。 TiFlash はデフォルトで`XXH3`アルゴリズムを使用し、検証フレームとアルゴリズムをカスタマイズできます。

## 検証メカニズム {#validation-mechanism}

検証メカニズムは、DeltaTree ファイル (DTFile) に基づいています。 DTFile は、 TiFlashデータを保持するstorageファイルです。 DTFile には次の 3 つの形式があります。

| バージョン | 州                         | 検証メカニズム                                                      | ノート                         |
| :---- | :------------------------ | :----------------------------------------------------------- | :-------------------------- |
| V1    | 非推奨                       | ハッシュはデータ ファイルに埋め込まれます。                                       |                             |
| V2    | バージョン &lt; v6.0.0 のデフォルト  | ハッシュはデータ ファイルに埋め込まれます。                                       | V1 と比較して、V2 は列データの統計を追加します。 |
| V3    | バージョン &gt;= v6.0.0 のデフォルト | V3 には、メタデータとトークン データのチェックサムが含まれており、複数のハッシュ アルゴリズムをサポートしています。 | v5.4.0 の新機能。                |

DTFile はデータファイルディレクトリの`stable`フォルダに格納されています。現在有効になっている形式はすべてフォルダー形式です。つまり、データは`dmf_<file id>`のような名前のフォルダーの下にある複数のファイルに保存されます。

### データ検証を使用する {#use-data-validation}

TiFlash は、自動データ検証と手動データ検証の両方をサポートしています。

-   自動データ検証:
    -   v6.0.0 以降のバージョンでは、デフォルトで V3 検証メカニズムが使用されます。
    -   v6.0.0 より前のバージョンでは、デフォルトで V2 検証メカニズムが使用されます。
    -   検証メカニズムを手動で切り替えるには、 [TiFlash構成ファイル](/tiflash/tiflash-configuration.md#configure-the-tiflashtoml-file)を参照してください。ただし、デフォルト構成はテストによって検証されているため、推奨されます。
-   手動データ検証。 [`DTTool inspect`](/tiflash/tiflash-command-line-flags.md#dttool-inspect)を参照してください。

> **警告：**
>
> V3 検証メカニズムを有効にすると、新しく生成された DTFile を v5.4.0 より前のTiFlashで直接読み取ることができなくなります。 v5.4.0 以降、 TiFlash はV2 と V3 の両方をサポートし、積極的にバージョンをアップグレードまたはダウングレードしません。既存のファイルのバージョンをアップグレードまたはダウングレードする必要がある場合は、手動で行う必要があります[バージョンを切り替える](/tiflash/tiflash-command-line-flags.md#dttool-migrate) 。

### 検証ツール {#validation-tool}

TiFlash がデータを読み取るときに実行される自動データ検証に加えて、データの整合性を手動でチェックするツールが v5.4.0 で導入されました。詳細については、 [DTツール](/tiflash/tiflash-command-line-flags.md#dttool-inspect)を参照してください。
