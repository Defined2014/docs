---
title: TiDB Backup & Restore Overview
summary: Learn about the definition and features of TiDB Backup & Restore.
aliases: ['/tidb/stable/point-in-time-recovery/']
---

# TiDB のバックアップと復元の概要 {#tidb-backup-x26-restore-overview}

Raftプロトコルと合理的な展開トポロジに基づいて、TiDB はクラスターの高可用性を実現します。クラスター内のいくつかのノードに障害が発生した場合でも、クラスターは引き続き使用できます。これに基づいて、データの安全性をさらに確保するために、TiDB は、自然災害や誤操作からデータを回復するための最後の手段として、バックアップと復元 (BR) 機能を提供します。

BRは次の要件を満たしています。

-   最短 5 分の RPO でクラスター データをディザスター リカバリー (DR) システムにバックアップし、災害シナリオでのデータ損失を減らします。
-   エラー イベントの前の時点にデータをロールバックすることにより、アプリケーションからの誤操作のケースを処理します。
-   司法監督の要件を満たすために履歴データの監査を実行します。
-   本番環境のクローンを作成します。これは、トラブルシューティング、パフォーマンス チューニング、およびシミュレーション テストに便利です。

## バックアップと復元を使用する {#use-backup-and-restore}

BRの使用方法は、TiDB のデプロイ方法によって異なります。このドキュメントでは、br コマンドライン ツールを使用して、オンプレミス展開で TiDB クラスター データをバックアップおよび復元する方法を紹介します。

他の展開シナリオでこの機能を使用する方法については、次のドキュメントを参照してください。

-   [TiDB Cloudにデプロイされた TiDB のバックアップと復元](https://docs.pingcap.com/tidbcloud/backup-and-restore) : [TiDB Cloud](https://www.pingcap.com/tidb-cloud/?from=en)で TiDB クラスターを作成することをお勧めします。 TiDB Cloudは完全に管理されたデータベースを提供し、アプリケーションに集中できるようにします。
-   [TiDB Operatorを使用したデータのバックアップと復元](https://docs.pingcap.com/tidb-in-kubernetes/stable/backup-restore-overview) : Kubernetes でTiDB Operatorを使用して TiDB クラスターをデプロイする場合は、Kubernetes CustomResourceDefinition (CRD) を使用してデータをバックアップおよび復元することをお勧めします。

## BRの特徴 {#br-features}

TiDB BRは次の機能を提供します。

-   クラスター データのバックアップ: 特定の時点でクラスターの完全なデータをバックアップする (**フル バックアップ**)、または TiDB のデータ変更をバックアップする (<strong>ログ バックアップ</strong>、ログは TiKV の KV 変更を意味します) ことができます。

-   バックアップ データを復元します。

    -   完全バックアップ、または完全バックアップ内の**特定のデータベースまたはテーブル**を<strong>復元</strong>できます。
    -   バックアップ データ (完全バックアップとログ バックアップ) に基づいて、ターゲット クラスターをバックアップ クラスターの任意の時点に復元できます。このタイプのリストアは、ポイント イン タイム リカバリ、略して PITR と呼ばれます。

### クラスタ データのバックアップ {#back-up-cluster-data}

完全バックアップは、特定の時点でのクラスターのすべてのデータをバックアップします。 TiDB は、次の完全バックアップの方法をサポートしています。

-   クラスターのスナップショットをバックアップする: TiDB クラスターのスナップショットには、特定の時点でトランザクション的に一貫性のあるデータが含まれています。詳細については、 [スナップショット バックアップ](/br/br-snapshot-guide.md#back-up-cluster-snapshots)を参照してください。

フル バックアップは多くのストレージ スペースを占有し、特定の時点のクラスタ データのみを含みます。必要に応じて復元ポイントを選択する場合、つまりポイント イン タイム リカバリ (PITR) を実行する場合は、次の 2 つのバックアップ方法を同時に使用できます。

-   [ログのバックアップ](/br/br-pitr-guide.md#start-log-backup)を開始します。ログ バックアップが開始された後、タスクはすべての TiKV ノードで実行され続け、TiDB の増分データを小さなバッチで定期的に指定されたストレージにバックアップします。
-   スナップショット バックアップを定期的に実行します。クラスタ データ全体をバックアップ ストレージにバックアップします。たとえば、毎日午前 0 時にクラスタ スナップショット バックアップを実行します。

#### バックアップのパフォーマンスと TiDB クラスターへの影響 {#backup-performance-and-impact-on-tidb-clusters}

-   TiDB クラスターに対するバックアップの影響は 20% 未満に抑えられており、TiDB クラスターを適切に構成することで、この値を 10% 以下に減らすことができます。 TiKV ノードのバックアップ速度はスケーラブルで、50 MB/秒から 100 MB/秒の範囲です。詳細については、 [バックアップのパフォーマンスと影響](/br/br-snapshot-guide.md#performance-and-impact-of-snapshot-backup)を参照してください。
-   ログ バックアップ タスクのみの場合、クラスターへの影響は約 5% です。ログ バックアップは、最後の更新後に生成されたすべての変更を 3 ～ 5 分ごとにバックアップ ストレージにフラッシュします。これ**により、目標復旧時点 (RPO) を 5 分で達成**できます。

### バックアップデータの復元 {#restore-backup-data}

バックアップ機能に対応して、フル リストアと PITR の 2 種類のリストアを実行できます。

-   完全バックアップを復元する

    -   クラスター スナップショット バックアップの復元: スナップショット バックアップ データを、空のクラスター、またはデータの競合がない (同じスキーマまたはテーブルを持つ) クラスターに復元できます。詳細については、 [スナップショット バックアップの復元](/br/br-snapshot-guide.md#restore-cluster-snapshots)を参照してください。さらに、バックアップ データから特定のデータベースまたはテーブルを復元し、不要なデータを除外することができます。詳細については、 [バックアップ データから特定のデータベースまたはテーブルを復元する](/br/br-snapshot-guide.md#restore-a-database-or-a-table)を参照してください。

-   データを任意の時点に復元 (PITR)

    -   `br restore point`コマンドを実行することで、復旧時点より前の最新のスナップショット バックアップ データを復元し、バックアップ データを指定した時点にログすることができます。 BRは、リストア スコープを自動的に決定し、バックアップ データにアクセスして、ターゲット クラスタにデータをリストアします。

#### TiDB クラスターのパフォーマンスと影響を復元する {#restore-performance-and-impact-on-tidb-clusters}

-   データの復元は、スケーラブルな速度で実行されます。通常、速度は TiKV ノードあたり 100 MiB/秒です。 `br`は、新しいクラスターへのデータの復元のみをサポートし、ターゲット クラスターのリソースを可能な限り使用します。詳細については、 [パフォーマンスと影響を回復する](/br/br-snapshot-guide.md#performance-and-impact-of-snapshot-restore)を参照してください。
-   各 TiKV ノードで、PITR は 30 GiB/h でログ データを復元できます。詳細については、 [PITRのパフォーマンスと影響](/br/br-pitr-guide.md#performance-and-impact-of-pitr)を参照してください。

## バックアップ ストレージ {#backup-storage}

TiDB は、Amazon S3、Google Cloud Storage (GCS)、Azure Blob Storage、NFS、およびその他の S3 互換ファイル ストレージ サービスへのデータのバックアップをサポートしています。詳細については、次のドキュメントを参照してください。

-   [URL でバックアップ ストレージを指定する](/br/backup-and-restore-storages.md#url-format)
-   [バックアップ ストレージへのアクセス権限を設定する](/br/backup-and-restore-storages.md#authentication)

## ご使用になる前に {#before-you-use}

このセクションでは、使用上のヒントや互換性の問題など、TiDB のバックアップと復元を使用するための前提条件について説明します。

### いくつかのヒント {#some-tips}

スナップショット バックアップ:

-   アプリケーションへの影響を最小限に抑えるために、オフピーク時にバックアップ操作を実行することをお勧めします。
-   複数のバックアップまたは復元操作を 1 つずつ実行することをお勧めします。バックアップ操作を並行して実行すると、パフォーマンスが低下します。さらに悪いことに、複数のタスク間のコラボレーションが不足していると、タスクが失敗し、クラスターのパフォーマンスに影響を与える可能性があります。

スナップショットの復元:

-   BRは、ターゲット クラスタのリソースを可能な限り使用します。したがって、新しいクラスターまたはオフラインのクラスターにデータを復元することをお勧めします。データを本番クラスターに復元することは避けてください。そうしないと、アプリケーションが影響を受ける可能性があります。 PITR は、空のクラスターへのデータの復元のみをサポートします。

ピット:

-   クラスター レベルの PITR のみを実行できます。データベース レベルおよびテーブル レベルの PITR はサポートされていません。
-   ユーザー テーブルまたは権限テーブルのデータを復元することはできません。

バックアップ ストレージとネットワーク構成:

-   Amazon S3、GCS、または Azure Blob Storage と互換性のあるストレージ システムにバックアップ データを保存することをお勧めします。
-   BR、TiKV、およびバックアップ ストレージ システムに十分なネットワーク帯域幅があり、ストレージ システムが十分な読み取りおよび書き込みパフォーマンス (IOPS) を提供できることを確認する必要があります。そうしないと、バックアップおよび復元中にパフォーマンスのボトルネックになる可能性があります。

### 互換性 {#compatibility}

#### 他の機能との互換性 {#compatibility-with-other-features}

一部の TiDB 機能が有効または無効になっていると、バックアップと復元がうまくいかないことがあります。これらの機能がバックアップと復元中に一貫して有効または無効にされない場合、互換性の問題が発生する可能性があります。

| 特徴                    | 問題                                               | 解決                                                                                                                                                                                                                                                                                                                                                                                           |
| --------------------- | ------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| GBK 文字セット             |                                                  | v5.4.0 より前のバージョンのBRは、 `charset=GBK`テーブルの復元をサポートしていません。 v5.4.0 より前の TiDB クラスターへの`charset=GBK`のテーブルの復元をサポートするBRのバージョンはありません。                                                                                                                                                                                                                                                                   |
| クラスタ化されたインデックス        | [#565](https://github.com/pingcap/br/issues/565) | リストア中の`tidb_enable_clustered_index`グローバル変数の値がバックアップ中の値と一致していることを確認してください。そうしないと、 `default not found`エラーやデータ インデックスの不整合など、データの不整合が発生する可能性があります。                                                                                                                                                                                                                                               |
| 新しい照合順序               | [#352](https://github.com/pingcap/br/issues/352) | 復元中の`new_collations_enabled_on_first_bootstrap`変数の値がバックアップ中の値と一致していることを確認してください。そうしないと、不整合なデータ インデックスが発生し、チェックサムが渡されない可能性があります。詳細については、 [FAQ - BRが`new_collations_enabled_on_first_bootstrap`不一致を報告するのはなぜですか?](/faq/backup-and-restore-faq.md#why-is-new_collations_enabled_on_first_bootstrap-mismatch-reported-during-restore)を参照してください。                                                   |
| グローバル一時テーブル           |                                                  | v5.3.0 以降のバージョンのBRを使用してデータをバックアップおよび復元していることを確認してください。そうしないと、バッキングされたグローバル一時テーブルの定義でエラーが発生します。                                                                                                                                                                                                                                                                                               |
| TiDB Lightning物理インポート |                                                  | 上流のデータベースがTiDB Lightningの物理インポートモードを使用している場合、ログバックアップでデータをバックアップできません。データのインポート後に完全バックアップを実行することをお勧めします。詳細については、 [アップストリーム データベースが物理インポート モードでTiDB Lightningを使用してデータをインポートすると、ログ バックアップ機能が使用できなくなります。なんで？](/faq/backup-and-restore-faq.md#when-the-upstream-database-imports-data-using-tidb-lightning-in-the-physical-import-mode-the-log-backup-feature-becomes-unavailable-why)を参照してください。 |

#### バージョンの互換性 {#version-compatibility}

バックアップとリストアを実行する前に、 BRは TiDB クラスターのバージョンを自身のものと比較して確認します。メジャー バージョンの不一致がある場合、 BRは終了するよう促します。バージョン チェックを強制的にスキップするには、 `--check-requirements=false`を設定します。バージョン チェックをスキップすると、互換性が失われる可能性があることに注意してください。

| バックアップ版（縦）\ 復元版（横）        | TiDB v6.0 に復元する                                                                                                       | TiDB v6.1 に復元する | TiDB v6.2 に復元する | TiDB v6.3 に復元する | TiDB v6.4 に復元する | TiDB v6.5 に復元する |
| ------------------------- | --------------------------------------------------------------------------------------------------------------------- | --------------- | --------------- | --------------- | --------------- | --------------- |
| TiDB v6.0 スナップショット バックアップ | 互換性                                                                                                                   | 互換性             | 互換性             | 互換性             | 互換性             | 互換性             |
| TiDB v6.1 スナップショット バックアップ | 互換性あり (既知の問題[#36379](https://github.com/pingcap/tidb/issues/36379) : バックアップ データに空のスキーマが含まれている場合、 BRがエラーを報告する場合があります。) | 互換性             | 互換性             | 互換性             | 互換性             | 互換性             |
| TiDB v6.2 スナップショット バックアップ | 互換性あり (既知の問題[#36379](https://github.com/pingcap/tidb/issues/36379) : バックアップ データに空のスキーマが含まれている場合、 BRがエラーを報告する場合があります。) | 互換性             | 互換性             | 互換性             | 互換性             | 互換性             |
| TiDB v6.3 スナップショット バックアップ | 互換性あり (既知の問題[#36379](https://github.com/pingcap/tidb/issues/36379) : バックアップ データに空のスキーマが含まれている場合、 BRがエラーを報告する場合があります。) | 互換性             | 互換性             | 互換性             | 互換性             | 互換性             |
| TiDB v6.3 ログ バックアップ       | なし                                                                                                                    | なし              | 非互換             | 互換性             | 互換性             | 互換性             |
| TiDB v6.4 ログ バックアップ       | なし                                                                                                                    | なし              | 非互換             | 互換性             | 互換性             | 互換性             |
| TiDB v6.5 ログ バックアップ       | なし                                                                                                                    | なし              | 非互換             | 互換性             | 互換性             | 互換性             |

## こちらもご覧ください {#see-also}

-   [TiDB スナップショットのバックアップと復元ガイド](/br/br-snapshot-guide.md)
-   [TiDB ログのバックアップと PITR ガイド](/br/br-pitr-guide.md)
-   [バックアップ ストレージ](/br/backup-and-restore-storages.md)
